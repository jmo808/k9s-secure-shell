---
# HTTPRoute for ephemeral K9s sessions
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: ephemeral-k9s-route
  namespace: admin-web
  labels:
    app: ephemeral-k9s
spec:
  parentRefs:
  - name: public-gateway
    namespace: kube-system
    sectionName: https
  
  hostnames:
  - "admin.blackbutterfly.mx"
  
  rules:
  # Redirect HTTP to HTTPS
  - matches:
    - path:
        type: PathPrefix
        value: /
      headers:
      - name: x-forwarded-proto
        value: http
    filters:
    - type: ResponseHeaderModifier
      responseHeaderModifier:
        set:
        - name: Location
          value: "https://admin.blackbutterfly.mx{request.url.path}"
    - type: ExtensionRef
      extensionRef:
        group: gateway.cilium.io
        kind: CiliumClusterWideNetworkPolicy
        name: redirect-to-https
  
  # Main application route (HTTPS)
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: oauth2-proxy-service
      port: 4180

---
# Network policy to allow traffic between components
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ephemeral-k9s-network-policy
  namespace: admin-web
spec:
  podSelector:
    matchLabels:
      app: ephemeral-k9s-proxy
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Allow traffic from Cilium gateway
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    - namespaceSelector:
        matchLabels:
          name: k9s-sessions
    ports:
    - protocol: TCP
      port: 4180
  
  egress:
  # Allow to session launcher
  - to:
    - podSelector:
        matchLabels:
          app: session-launcher
    ports:
    - protocol: TCP
      port: 8080
  
  # Allow to ephemeral session pods
  - to:
    - podSelector:
        matchLabels:
          app: k9s-session
    ports:
    - protocol: TCP
      port: 7681
      
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
      
  # Allow HTTPS to external OAuth provider
  - to: []
    ports:
    - protocol: TCP
      port: 443